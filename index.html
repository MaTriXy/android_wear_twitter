<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Android wear twitter by saulmm</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Android wear twitter</h1>
        <p></p>

        <p class="view"><a href="https://github.com/saulmm/android_wear_twitter">View the Project on GitHub <small>saulmm/android_wear_twitter</small></a></p>


        <ul>
          <li><a href="https://github.com/saulmm/android_wear_twitter/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/saulmm/android_wear_twitter/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/saulmm/android_wear_twitter">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="twitter-client-for-android-wear" class="anchor" href="#twitter-client-for-android-wear"><span class="octicon octicon-link"></span></a>Twitter client for android wear</h1>

<div><img src="https://googledrive.com/host/0B62SZ3WRM2R2RURpRkhYdG5PZjg"></div>

<h2>
<a name="1-motivation" class="anchor" href="#1-motivation"><span class="octicon octicon-link"></span></a>1. Motivation</h2>

<p>The motivation of this project was to learn how the android wear framework works, using theirs views, communication APIs, etc...</p>

<p>A second objective was to share it as a reference project, so others can use it, modify it or make whatever they want with it. </p>

<p>I think that is very useful to learn by examples, so I really aprecciate projects like this.</p>

<h2>
<a name="2-project-structure" class="anchor" href="#2-project-structure"><span class="octicon octicon-link"></span></a>2. Project structure</h2>

<p>If you create a project with android wear and android studio, when the wizard finishes, you will see two main modules: <strong>wear</strong> and <strong>mobile</strong>.</p>

<p>When you make an android wear <em>release</em>, you get a single <em>.apk</em>, which will be downloaded from google play by your users, when one of them install your app on their phone, another app will be installed automatically on their wearable. That is because the release <em>apk's</em> with android wear, has a 'micro-apk' hidden inside them.</p>

<p>That <em>micro-apk</em> is built by the <strong>wear</strong> module.</p>

<div><img src="https://87ccd03f34f5850e9f58050faacff843fdb2a928.googledrive.com/host/0B62SZ3WRM2R2TDVIN2ptNGVndE0"></div>

<p>At develop time, you can compile your <strong>wear</strong> module directly on your wear device or emulator.</p>

<h2>
<a name="3-the-handheld-app" class="anchor" href="#3-the-handheld-app"><span class="octicon octicon-link"></span></a>3. The handheld app</h2>

<p>Like a normal android app, has an <em>activity</em>, a few <em>fragments</em> and some <em>layouts</em>, the user, when press the <em>login</em> button, will see a browser with a twitter login, if everything goes well after insert they twitter credentials, the main fragment will change and the user will see their twitter profile photo, username, and the background will turn to their twitter profile background.</p>

<div><img src="https://cef58420144e1df00f893fa4436747dce6972cb0.googledrive.com/host/0B62SZ3WRM2R2V0Y2MlpwR3lEcUU"></div>

<p>The interesting part from my point of view is the communication with the wearable. </p>

<p>The clock always could ask the list of tweets, so the class that asks twitter for the tweets must be always available and able to take care of it, so I think that a <a href="http://developer.android.com/guide/components/services.html">service</a> is the best choice.</p>

<div class="highlight highlight-xml"><pre><span class="nt">&lt;service</span> <span class="na">android:name=</span><span class="s">".services.WearService"</span><span class="nt">/&gt;</span>
</pre></div>

<p>That service must be started when the device boots, otherwise the user would have to open the application after start manually, I do not think it is the best usability choice. That can be solved easily with a <a href="http://developer.android.com/reference/android/content/BroadcastReceiver.html">broadcast receiver</a>.</p>

<div class="highlight highlight-xml"><pre><span class="nt">&lt;receiver</span> <span class="na">android:name=</span><span class="s">".receivers.BootReceiver"</span> <span class="na">android:enabled=</span><span class="s">"true"</span> <span class="na">android:exported=</span><span class="s">"false"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;intent-filter&gt;</span>
    <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"android.intent.action.BOOT_COMPLETED"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/receiver&gt;</span>
</pre></div>

<p>For all twitter connections I had relied in the library <a href="http://twitter4j.org/en/index.html">twitter4j</a>, a very mature and complete java library responsible for all interaction with twitter APIs, you only have to create an app in <a href="https://dev.twitter.com/">twitter developers</a>, <strong>twitter4j</strong> will do the hard work.</p>

<h3>
<a name="wearable-comunication" class="anchor" href="#wearable-comunication"><span class="octicon octicon-link"></span></a>Wearable comunication</h3>

<p>And here is the fun part, after reviewing the documentation of <a href="http://developer.android.com/training/wearables/data-layer/index.html">android developers</a>  I realized that the communication with the wearable device is almost trivial. There are certain steps that must be respected:</p>

<ol>
<li>Connect with <strong>Google Play Services</strong>
</li>
</ol><div class="highlight highlight-java"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
   <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>

   <span class="c1">// Init &amp; connect gApiClient</span>
   <span class="n">googleApiClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Builder</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
      <span class="o">.</span><span class="na">addConnectionCallbacks</span> <span class="o">(</span><span class="n">gConnectionCallbacks</span><span class="o">)</span>
      <span class="o">.</span><span class="na">addOnConnectionFailedListener</span> <span class="o">(</span><span class="n">gConnectionFailed</span><span class="o">)</span>
      <span class="o">.</span><span class="na">addApi</span><span class="o">(</span><span class="n">Wearable</span><span class="o">.</span><span class="na">API</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>

<ol>
<li>Call <code>.connect()</code> method</li>
</ol><p>You can put this call in the your activity <code>onStart()</code> method</p>

<div class="highlight highlight-java"><pre>   <span class="n">googleApiClient</span><span class="o">.</span><span class="na">connect</span><span class="o">();</span>
</pre></div>

<ol>
<li>Wait <code>onConnected()</code> to be called</li>
</ol><p>At this point, the device is ready to <em>talk</em> with android wear devices if all went well, otherwhise the <code>onConnectionFailedListener</code> would be fired.</p>

<div class="highlight highlight-java"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="n">ConnectionCallbacks</span> <span class="n">gConnectionCallbacks</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ConnectionCallbacks</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onConnected</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">bundle</span><span class="o">)</span> <span class="o">{</span>

       <span class="c1">// Subscribe wear listeners</span>
       <span class="n">Wearable</span><span class="o">.</span><span class="na">MessageApi</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">googleApiClient</span><span class="o">,</span> <span class="n">wearMessageListener</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onConnectionSuspended</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>

        <span class="o">[...]</span>
    <span class="o">}</span>
<span class="o">};</span>
</pre></div>

<p>Now there are available the communication APIs that google provide us, there are 3 APIs wich can be used: <a href="http://developer.android.com/reference/com/google/android/gms/wearable/MessageApi.html">MessageApi</a>, <a href="https://developer.android.com/reference/com/google/android/gms/wearable/NodeApi.html">NodeApi</a> &amp; <a href="http://developer.android.com/reference/com/google/android/gms/wearable/DataApi.html">DataApi</a>.</p>

<h3>
<a name="messageapi" class="anchor" href="#messageapi"><span class="octicon octicon-link"></span></a>MessageApi</h3>

<p>The first communication from the wearable tries to find out if the service is running, is something like:</p>

<p>_Hi men !  _
_Here I am :) _<br></p>

<p>In the <em>wear</em> language you are sending the following messages:</p>

<p><code>/tweets/state/hi/</code> <em>(wearable)</em> 
<code>/tweets/state/how4u/</code> <em>(device)</em> <br></p>

<p>Both modules, <em>mobile</em> &amp; <em>wear</em> have the same implementation of an asynctask used to send messages with the <code>MessageApi</code>.</p>

<div class="highlight highlight-java"><pre><span class="kd">class</span> <span class="nc">SendMessageTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span> <span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>

   <span class="n">SendMessageTask</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">protected</span> <span class="n">Void</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>

       <span class="c1">// Such as /wear/message</span>
       <span class="n">String</span> <span class="n">activityPath</span> <span class="o">=</span> <span class="n">message</span><span class="o">;</span>

       <span class="n">MessageApi</span><span class="o">.</span><span class="na">SendMessageResult</span> <span class="n">result</span> <span class="o">=</span>  <span class="n">MessageApi</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span>
           <span class="n">googleApiClient</span><span class="o">,</span> <span class="n">connectedNodes</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getId</span><span class="o">(),</span> 
           <span class="n">activityPath</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span>
           <span class="o">.</span><span class="na">await</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>After call to <code>googleApiClient()</code>and wait to <code>onConnected()</code> were called, the service was registered to receive message events using the <code>Wearable.MessageApi.addListener(googleApiClient, myListener)</code> method, so the service is now able to handle incoming messages with this method:</p>

<div class="highlight highlight-java"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="n">MessageApi</span><span class="o">.</span><span class="na">MessageListener</span> <span class="n">wearMessageListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageApi</span><span class="o">.</span><span class="na">MessageListener</span><span class="o">()</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessageReceived</span><span class="o">(</span><span class="n">MessageEvent</span> <span class="n">messageEvent</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">messageEvent</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">"[DEBUG] WearService - onMessageReceived"</span><span class="o">,</span> <span class="s">"Message received: "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>

        <span class="o">[...]</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h3>
<a name="nodeapi" class="anchor" href="#nodeapi"><span class="octicon octicon-link"></span></a>NodeApi</h3>

<p>The <a href="https://developer.android.com/reference/com/google/android/gms/wearable/NodeApi.html">NodeApi</a> as the documentation says, exposes to learn about local or connected Nodes, so you can figure out what nodes (<em>wear devices</em>) are connected to the handfeld app. I created another asynctask to get the connected nodes:</p>

<div class="highlight highlight-java"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GetNodesTask</span> <span class="kd">extends</span> <span class="n">AsyncTask</span> <span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">ArrayList</span> <span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">GoogleApiClient</span> <span class="n">googleApiClient</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ServiceNodeListener</span> <span class="n">nodeListener</span><span class="o">;</span>


    <span class="kd">public</span> <span class="nf">GetNodesTask</span><span class="o">(</span><span class="n">ServiceNodeListener</span> <span class="n">nodeListener</span><span class="o">,</span> <span class="n">GoogleApiClient</span> <span class="n">googleApiClient</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">nodeListener</span> <span class="o">=</span> <span class="n">nodeListener</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">googleApiClient</span> <span class="o">=</span> <span class="n">googleApiClient</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">ArrayList</span> <span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">NodeApi</span><span class="o">.</span><span class="na">GetConnectedNodesResult</span> <span class="n">nodes</span> <span class="o">=</span>
                <span class="n">Wearable</span><span class="o">.</span><span class="na">NodeApi</span><span class="o">.</span><span class="na">getConnectedNodes</span><span class="o">(</span><span class="n">googleApiClient</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">await</span><span class="o">();</span>

        <span class="k">return</span> <span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;)</span> <span class="n">nodes</span><span class="o">.</span><span class="na">getNodes</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="n">ArrayList</span> <span class="o">&lt;</span><span class="n">Node</span><span class="o">&gt;</span> <span class="n">nodes</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">nodes</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">nodes</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">nodes</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">nodeListener</span><span class="o">.</span><span class="na">onNodesReceived</span><span class="o">(</span><span class="n">nodes</span><span class="o">);</span>

        <span class="k">else</span>
            <span class="n">nodeListener</span><span class="o">.</span><span class="na">onFailedNodes</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>When the wear nodes are received, you use the MessageApi or the DataApi with that nodes, I always used the first wearable connected to the main device, it would be nice select what wearable do you want to use if there is more than one.</p>

<h3>
<a name="dataapi" class="anchor" href="#dataapi"><span class="octicon octicon-link"></span></a>DataApi</h3>

<p>The <a href="http://developer.android.com/reference/com/google/android/gms/wearable/DataApi.html">DataApi</a> allows you to synchronice data between the handhelf app and wearables, a message in the DataApi consists of a <strong>Payload</strong>, to send whatever data you wish, and a <strong>Path</strong>, a unique string starting with a forward slash.</p>

<p>Instead to send a byte array you can use <a href="http://developer.android.com/reference/com/google/android/gms/wearable/DataMap.html">DataMaps</a> which are used as an android <a href="http://developer.android.com/reference/android/os/Bundle.html">bundle</a> inside the DataApi.</p>

<p>To send &amp; receive the tweets from the handfeld to the wear device, I have used <a href="http://developer.android.com/reference/com/google/android/gms/wearable/DataMap.html">DataMaps</a> with strings composed by fields separed by a pattern (Maybe this is not the best option).</p>

<p>In this case, I have implemented an <em>asynctask</em> for send the twitter timeline after receiving it by <em>twitter4j</em>. The timeline is sent as an <code>ArrayList&lt;String&gt;</code></p>

<div class="highlight highlight-java"><pre><span class="kd">class</span> <span class="nc">SendTimeLineTask</span>  <span class="kd">extends</span> <span class="n">AsyncTask</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ArrayList</span> <span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span>  <span class="n">contents</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SendTimeLineTask</span> <span class="o">(</span><span class="n">Context</span> <span class="n">c</span><span class="o">,</span> <span class="n">ArrayList</span> <span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">contents</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">contents</span> <span class="o">=</span> <span class="n">contents</span><span class="o">;</span>
<span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Void</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="n">Void</span><span class="o">...</span> <span class="n">nodes</span><span class="o">)</span> <span class="o">{</span>

      <span class="n">PutDataMapRequest</span> <span class="n">dataMap</span> <span class="o">=</span> <span class="n">PutDataMapRequest</span>
        <span class="o">.</span><span class="na">create</span> <span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">TIME_LINE_DATA</span><span class="o">);</span>

      <span class="n">dataMap</span><span class="o">.</span><span class="na">getDataMap</span><span class="o">().</span><span class="na">putStringArrayList</span><span class="o">(</span><span class="s">"contents"</span><span class="o">,</span> <span class="n">contents</span><span class="o">);</span>

      <span class="n">PutDataRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">dataMap</span><span class="o">.</span><span class="na">asPutDataRequest</span><span class="o">();</span>

      <span class="n">DataApi</span><span class="o">.</span><span class="na">DataItemResult</span> <span class="n">dataItemResult</span> <span class="o">=</span> <span class="n">Wearable</span><span class="o">.</span><span class="na">DataApi</span>
        <span class="o">.</span><span class="na">putDataItem</span><span class="o">(</span><span class="n">googleApiClient</span><span class="o">,</span> <span class="n">request</span><span class="o">)</span>
        <span class="o">.</span><span class="na">await</span><span class="o">();</span>

      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h3>
<a name="4wearable-app" class="anchor" href="#4wearable-app"><span class="octicon octicon-link"></span></a>4.Wearable app</h3>

<div><img src="https://219ede0846187d7fd9922311fa441d9820915b2c.googledrive.com/host/0B62SZ3WRM2R2bHhlVExmakJEaFU"></div>

<p>An application for android wear is programmed like a normal android app, with a few differences, you can't all the android APIs that you normally use in a common android app such as <code>android.net</code>. Also,  you have to notice that the user experience is a little bit difference than a normal Android app.</p>

<p>The wear app, is composed by the following activities:</p>

<ul>
<li><p><code>WaitActivity</code> - An activity shown meanwhile the handfeld app is requesting the user timeline. In backwards this activity makes a hard work of communication with the handfeld app.</p></li>
<li><p><code>StreamActivity</code>- An activity that shows the user <em>timeline</em>, also allows to <em>retweet</em> a tweet or flag as favorited.</p></li>
</ul><h4>
<a name="waitactivity" class="anchor" href="#waitactivity"><span class="octicon octicon-link"></span></a>WaitActivity</h4>

<p>The effect of the 'spinner' is a simple ImageView, with the following animation applied</p>

<div><img src="https://3a3c2487a21adf7eab9f9e1c949cb1c6fbc1a71f.googledrive.com/host/0B62SZ3WRM2R2MldQdDNXVTk5bmc"></div>
  

<div class="highlight highlight-xml"><pre><span class="nt">&lt;rotate</span>
    <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
    <span class="na">android:duration=</span><span class="s">"1000"</span>
    <span class="na">android:repeatCount=</span><span class="s">"infinite"</span>
    <span class="na">android:fromDegrees=</span><span class="s">"0"</span>
    <span class="na">android:interpolator=</span><span class="s">"@android:anim/anticipate_overshoot_interpolator"</span>
    <span class="na">android:pivotX=</span><span class="s">"50%"</span>
    <span class="na">android:pivotY=</span><span class="s">"50%"</span>
    <span class="na">android:toDegrees=</span><span class="s">"359"</span> <span class="nt">/&gt;</span>
</pre></div>

<div class="highlight highlight-java"><pre>  <span class="n">loadingSegment</span> <span class="o">=</span> <span class="o">(</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">loading_segment</span><span class="o">);</span>
  <span class="n">loadingSegment</span><span class="o">.</span><span class="na">startAnimation</span><span class="o">(</span><span class="n">AnimationUtils</span><span class="o">.</span><span class="na">loadAnimation</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">R</span><span class="o">.</span><span class="na">anim</span><span class="o">.</span><span class="na">loading_animation</span><span class="o">));</span>
</pre></div>

<p>If there is any problem the 'Loading...' message will turn to show the error and the background, produced by a <code>&lt;transition&gt;</code></p>

<div><img src="https://919c5da1a105a3a06e03fa4ec2c9901a70398228.googledrive.com/host/0B62SZ3WRM2R2TXNNWlJPREVXQTA"></div>

<div class="highlight highlight-xml"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;transition</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;item</span> <span class="na">android:drawable=</span><span class="s">"@drawable/wait_idle"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;item</span> <span class="na">android:drawable=</span><span class="s">"@drawable/wait_error"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/transition&gt;</span>
</pre></div>

<div class="highlight highlight-java"><pre><span class="o">&lt;</span><span class="n">FrameLayout</span> <span class="nl">xmlns:</span><span class="n">android</span><span class="o">=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
    <span class="o">...</span>
    <span class="nl">android:</span><span class="n">background</span><span class="o">=</span><span class="s">"@drawable/tr_error"</span>
    <span class="o">...</span>
    <span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">FrameLayout</span><span class="o">&gt;</span>    
</pre></div>

<p>A protocol of messages is established to perform the communication, first of all, in the <code>WaitActivity</code> a message task is sent with the messaje 'available', after 3 seconds if the handfeld app doesn't responds, it means that there is a problem with the service, so show the proper message to the user. </p>

<p>If the handfeld app responds successfully the wearable will sent another message taks to tell the handfeld app that has to start to request the user tweets, when the request is done, the handfeld app will sent a DataTask with a list of tweets</p>

<p>The wear message listener...</p>

<div class="highlight highlight-java"><pre>  <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessageReceived</span><span class="o">(</span><span class="n">MessageEvent</span> <span class="n">messageEvent</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">String</span> <span class="n">messagePath</span> <span class="o">=</span> <span class="n">messageEvent</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">messagePath</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/tweets/operation/ok"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">onRetweetListener</span><span class="o">.</span><span class="na">onActionOK</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">messagePath</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/tweets/operation/fail"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">onRetweetListener</span><span class="o">.</span><span class="na">onActionFail</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">messagePath</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/tweets/state/no_internet"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">deviceListener</span><span class="o">.</span><span class="na">onProblem</span><span class="o">(</span><span class="n">messagePath</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">messagePath</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/tweets/state/available"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">isTwitterServiceIsRunning</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>

<p>The tweets message listener (DataListener):</p>

<div class="highlight highlight-java"><pre>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDataChanged</span><span class="o">(</span><span class="n">DataEventBuffer</span> <span class="n">dataEvents</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">DataEvent</span> <span class="nl">event:</span> <span class="n">dataEvents</span><span class="o">)</span> <span class="o">{</span>

            <span class="n">String</span> <span class="n">eventUri</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getDataItem</span><span class="o">().</span><span class="na">getUri</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">eventUri</span><span class="o">.</span><span class="na">contains</span> <span class="o">(</span><span class="s">"/twitter/timeline"</span><span class="o">))</span> <span class="o">{</span>

                <span class="n">DataMapItem</span> <span class="n">dataItem</span> <span class="o">=</span> <span class="n">DataMapItem</span><span class="o">.</span><span class="na">fromDataItem</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getDataItem</span><span class="o">());</span>
                <span class="n">ArrayList</span> <span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">tweets</span> <span class="o">=</span> <span class="n">dataItem</span><span class="o">.</span><span class="na">getDataMap</span><span class="o">().</span><span class="na">getStringArrayList</span><span class="o">(</span><span class="s">"contents"</span><span class="o">);</span>
                <span class="n">deviceListener</span><span class="o">.</span><span class="na">onTimeLimeReceived</span><span class="o">(</span><span class="n">tweets</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>

<h4>
<a name="protocol" class="anchor" href="#protocol"><span class="octicon octicon-link"></span></a>Protocol:</h4>

<p><strong>To get the timeline in the wearable:</strong></p>

<p>"/tweets/hi/"                   <em>(Wearable)</em>    <em>MessageApi</em>  <br>
"/tweets/state/available"       <em>(Device)</em>      <em>MessageApi</em> <br>
"/twitter/timeline"             <em>(Wearable)</em>    <em>MessageApi</em> <br>
"/twitter/timeline"             <em>(Device)</em>      <em>DataApi</em></p>

<p><br><strong>Retweet a tweet:</strong></p>

<p>"/tweets/retweet/"                  <em>(Wearable)</em>    <em>MessageApi</em> <br>
"/tweets/operation/ok"              <em>(Device)</em>      <em>MessageApi</em><br>
"/tweets/operation/fail"                <em>(Device)</em>      <em>MessageApi</em></p>

<p><br><strong>Flag a tweet as favorite:</strong></p>

<p>"/tweets/favorite/"                 <em>(Wearable)</em>    <em>MessageApi</em> <br>
"/tweets/operation/ok"              <em>(Device)</em>      <em>MessageApi</em><br>
"/tweets/operation/fail"            <em>(Device)</em>      <em>MessageApi</em></p>

<h2>
<a name="streamactivity" class="anchor" href="#streamactivity"><span class="octicon octicon-link"></span></a>StreamActivity</h2>

<p>After <em>'WaitActivity'</em> do the hard work, the <em>'StreamActivity'</em> will be shown, this one will show a <code>GridViewPager</code>, that view will allow to scroll down seeing the available tweets, scrolling right the user will be able to rewtweet a tweet o flag one as favorite.</p>

<p>The <code>GridViewPager</code> works with a <code>FragmentGridAdapter</code>, that works like the common adapters used in <code>ListViews</code>, <code>GridViews</code>, etc...</p>

<div class="highlight highlight-java"><pre>        <span class="o">...</span>
        <span class="n">streamPager</span> <span class="o">=</span> <span class="o">(</span><span class="n">GridViewPager</span><span class="o">)</span> <span class="n">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">stream_pager</span><span class="o">);</span>

        <span class="n">streamPager</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="k">new</span> <span class="nf">TwitterAdapter</span> <span class="o">(</span><span class="n">StreamActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span>
                <span class="n">getFragmentManager</span><span class="o">(),</span> <span class="n">visibleTweets</span><span class="o">));</span>

        <span class="o">...</span>
</pre></div>

<div class="highlight highlight-java"><pre>    <span class="kd">class</span> <span class="nc">TwitterAdapter</span> <span class="kd">extends</span> <span class="n">FragmentGridPagerAdapter</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">Context</span> <span class="n">context</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Tweet</span><span class="o">&gt;</span> <span class="n">tweets</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">TwitterAdapter</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">FragmentManager</span> <span class="n">fm</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Tweet</span><span class="o">&gt;</span> <span class="n">tweets</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">fm</span><span class="o">);</span>

            <span class="k">this</span><span class="o">.</span><span class="na">tweets</span> <span class="o">=</span> <span class="n">tweets</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Fragment</span> <span class="nf">getFragment</span><span class="o">(</span><span class="kt">int</span> <span class="n">row</span><span class="o">,</span> <span class="kt">int</span> <span class="n">column</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Tweet</span> <span class="n">currentTweet</span> <span class="o">=</span> <span class="n">tweets</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">row</span><span class="o">);</span>
            <span class="n">TwitterActionFragment</span> <span class="n">twitterActionFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">TwitterActionFragment</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">column</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">TweetFragment</span> <span class="n">tf</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">TweetFragment</span><span class="o">();</span>
                <span class="n">tf</span><span class="o">.</span><span class="na">setCardTweet</span><span class="o">(</span><span class="n">currentTweet</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">tf</span><span class="o">;</span>

            <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">column</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">twitterActionFragment</span><span class="o">.</span><span class="na">setTwAction</span><span class="o">(</span><span class="n">TwitterAction</span><span class="o">.</span><span class="na">RETWEET</span><span class="o">);</span>

            <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">column</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">twitterActionFragment</span><span class="o">.</span><span class="na">setTwAction</span><span class="o">(</span><span class="n">TwitterAction</span><span class="o">.</span><span class="na">FAVORITE</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">twitterActionFragment</span><span class="o">.</span><span class="na">setCurrentTweet</span><span class="o">(</span><span class="n">currentTweet</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">twitterActionFragment</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getRowCount</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">tweets</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getColumnCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">row</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">3</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>

<p>And the layout</p>

<div class="highlight highlight-xml"><pre><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>

<span class="nt">&lt;LinearLayout</span>
    <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
    <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
    <span class="na">android:layout_height=</span><span class="s">"match_parent"</span>
    <span class="na">android:orientation=</span><span class="s">"vertical"</span>
    <span class="na">android:background=</span><span class="s">"@drawable/tw_wall"</span>
    <span class="nt">&gt;</span>

    <span class="nt">&lt;android.support.wearable.view.GridViewPager</span>
    <span class="na">android:id=</span><span class="s">"@+id/stream_pager"</span>
    <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
    <span class="na">android:layout_height=</span><span class="s">"match_parent"</span>
    <span class="na">android:keepScreenOn=</span><span class="s">"true"</span>
    <span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>

__NOTE__ _There is a known bug , sometimes the handfeld service is not retweeting and marking a tweet as favorite well, that's because the twitter keys expires. Will be fixed soon_

### Third party libraries

- [Picasso](http://square.github.io/picasso/)
- [CircleImageView](https://github.com/hdodenhof/CircleImageView)
- [Android flat button](https://github.com/hoang8f/android-flat-button)
- [twitter4j](http://twitter4j.org/en/index.html)
</pre></div>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/saulmm">saulmm</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>